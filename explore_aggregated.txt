# explore_aggregated.py

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# Load dataset
df = pd.read_csv("data/histo_trafic.csv", sep=";", encoding="latin1")

# Clean the dataset based on earlier notebook steps
df = df.loc[:, ~df.columns.str.contains("^Unnamed")]
df["tstamp_clean"] = df["tstamp"].str.replace(r"^[a-zA-Zéûîôàç]+\s+", "", regex=True)

month_map = {"janvier":"January","février":"February","mars":"March","avril":"April","mai":"May","juin":"June",
             "juillet":"July","août":"August","septembre":"September","octobre":"October","novembre":"November","décembre":"December"}
for fr, en in month_map.items():
    df["tstamp_clean"] = df["tstamp_clean"].str.replace(fr, en, regex=False)

df["tstamp"] = pd.to_datetime(df["tstamp_clean"], format="%d %B %Y")
df = df.drop(columns="tstamp_clean")
df = df.sort_values(["secteur", "tstamp"])
df["trafic_mbps"] = pd.to_numeric(df["trafic_mbps"], errors="coerce")
df = df.dropna(subset=["trafic_mbps"])

# Display basic info
print("Total number of records:", len(df))
print("Number of unique sectors:", df["secteur"].nunique())

df_agg = df.groupby("tstamp")["trafic_mbps"].sum().reset_index()
df_agg = df_agg.sort_values("tstamp")

plt.figure(figsize=(14, 5))
plt.plot(df_agg["tstamp"], df_agg["trafic_mbps"], label="Aggregated Traffic (All Sectors)", color='tab:blue')
plt.title("Total Network Traffic Trend over Time")
plt.xlabel("Date")
plt.ylabel("Traffic (Mbps)")
plt.legend()
plt.grid(True)
plt.show()

from src.config import KTHParams
from src.utils import rolling_variance_proxy
from src.kth_ipp import generate_fine_series_from_coarse

coarse_agg = df_agg["trafic_mbps"].to_numpy()

# Set up the IPP parameters representing the aggregate model
p_macro = KTHParams(
    T=300.0,       # 5 minutes coarse duration
    tau=1/15,      # ON mean duration
    zeta=1/15,     # OFF mean duration
    lambda_fixed=0.5, 
    dt=60.0        # Granularité 60s as in teacher's plot
)

# Generate the fine synthetic traffic
fine_macro, report_macro, recon_macro = generate_fine_series_from_coarse(
    coarse_agg,
    coarse_var=rolling_variance_proxy(coarse_agg, k=6, var_floor_ratio=0.01, tau=p_macro.tau, zeta=p_macro.zeta, T=p_macro.T),
    p=p_macro,
    seed=42
)

# Plotting the synthesized overlay!
steps = int(p_macro.T / p_macro.dt)
coarse_step = np.repeat(coarse_agg, steps)
fine_series = fine_macro[:len(coarse_step)]

plt.figure(figsize=(14, 5))
plt.plot(coarse_step, label="Trafic Réel (valeur brute agregée)", alpha=0.5, color='tab:blue')
plt.plot(fine_series, label="Simulé (IPP 60s)", alpha=0.7, color='tab:red', linewidth=1)
plt.title("Comparaison Trafic Réel vs Simulé (Granularité 60s)")
plt.xlabel("Points (60s)")
plt.ylabel("Débit Mbps")
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()
